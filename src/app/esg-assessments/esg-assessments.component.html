<div class="esg-page">

  <!--  Top Header  -->
  <header class="esg-header">
    <h2>üåø ESG Assessment Checklist</h2>
  </header>
  <div class="progress-wrapper">
    <div class="progress-text">
      {{ answeredCount }} / {{ totalCount }} answered
    </div>

    <p-progressBar [value]="(answeredCount / totalCount) * 100" [showValue]="false" styleClass="green-progress">
    </p-progressBar>
  </div>
  <!-- ESG Summary - Visible only after submission -->
  <div #summarySection class="esg-summary" *ngIf="summary">

    <div class="summary-header-bar">
      <h3>‚úÖ ESG Assessment Summary</h3>
      <p-chip [label]="summary.rating" [styleClass]="getRatingClass(summary.rating)"></p-chip>
    </div>

    <div *ngIf="isReadOnly" class="locked-banner">
      <i class="pi pi-lock"></i>
      This ESG assessment has been submitted for appraisal and is now preview-only.
    </div>

    <div class="summary-overview">

      <!-- Average Score -->
      <div class="average-score-box">
        <span>Average Score</span>
        <h2>{{ summary.averageScore | number:'1.0-1' }}</h2>
        <p>{{ summary.rating }} Risk</p>

        <p-progressBar [value]="summary.averageScore" [showValue]="true"
          [styleClass]="'average-progress ' + getAverageScoreClass(summary.averageScore)">
        </p-progressBar>
      </div>

      <!-- Total Score & Weight -->
      <div class="average-score-box metrics-box">
        <div class="metric-col">
          <span><i class="pi pi-database"></i> Total Score</span>
          <h2>{{ summary.totalScore | number:'1.0-1' }}</h2>
        </div>

        <div class="metric-divider"></div>

        <div class="metric-col">
          <span><i class="pi pi-chart-line"></i> Total Weight</span>
          <h2>{{ summary.totalWeight | number:'1.0-1' }}</h2>
        </div>
      </div>

      <!-- Summary Comment -->
      <div class="summary-comment-card">
        <label for="summaryComment">
          <i class="pi pi-comment"></i>
          ESG Assessment Comment
        </label>

        <textarea id="summaryComment" pInputTextarea rows="4" [(ngModel)]="summary.comment" class="summary-textarea"
          disabled="true">
    </textarea>
      </div>

    </div>

  </div>
<!-- ===============================
     ESG EXPLAINABILITY (REVIEW MODE)
================================ -->
<p-accordion
  *ngIf="explainability"
  [multiple]="true"
  [activeIndex]="isReadOnly ? [] : [0]">

  <p-accordionTab>
<ng-template pTemplate="header">
  <div class="accordion-header green">
    <i class="pi pi-leaf"></i>
    <span class="title">ESG Explainability</span>
    <span class="subtitle">
      How responses influenced the ESG risk outcome
    </span>
  </div>
</ng-template>


    <!-- FLAGS -->
    <div class="explainability-flags" *ngIf="explainability.flags.length">
      <h4><i class="pi pi-exclamation-triangle"></i> Risk Flags</h4>
      <ul>
        <li *ngFor="let flag of explainability.flags">
          {{ flag }}
        </li>
      </ul>
    </div>

    <!-- ITEM LEVEL EXPLANATION -->
    <div class="explainability-grid">
      <div
        class="explainability-card"
        *ngFor="let item of explainability.itemDetails"
        [ngClass]="item.impact.toLowerCase()">

        <div class="explainability-card-header">
          <span class="impact-chip" [class]="item.impact.toLowerCase()">
            {{ item.impact }}
          </span>
        </div>

        <h4>{{ item.question }}</h4>

        <div class="explainability-metrics">
          <div>
            <span>Score</span>
            <strong>{{ item.score }}</strong>
          </div>
          <div>
            <span>Weight</span>
            <strong>{{ item.weight }}</strong>
          </div>
          <div>
            <span>Contribution</span>
            <strong>{{ item.contribution | number:'1.0-0' }}%</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- MITIGATION -->
    <div class="mitigation-box" *ngIf="explainability.mitigationHints.length">
      <h4><i class="pi pi-shield"></i> Mitigation Guidance</h4>
      <ul>
        <li *ngFor="let hint of explainability.mitigationHints">
          {{ hint }}
        </li>
      </ul>
    </div>
  </p-accordionTab>
</p-accordion>
  <!-- ===============================
   FINAL AI RECOMMENDATION
================================ -->
  <div class="final-ai-recommendation" *ngIf="finalRecommendation">

    <div class="final-ai-header">
      <h3>ü§ñ Final AI ESG Recommendation</h3>
      <p-chip [label]="finalRiskLabel" [styleClass]="finalRiskClass">
      </p-chip>
    </div>

    <p class="final-ai-text">
      {{ finalRecommendation.recommendation }}
    </p>

    <div class="final-ai-confidence">
      <span>Decision Confidence</span>
      <p-progressBar [value]="finalRecommendation.confidence * 100" [showValue]="true">
      </p-progressBar>
    </div>

  </div>

  <!-- ===============================
   ML RISK SIGNALS (ADVISORY)
================================ -->
<div class="ml-signal-card" *ngIf="finalRecommendation?.mlSignals">

  <div class="ml-signal-header">
    <h3>üìä ML Risk Signals</h3>
    <p-chip
      [label]="finalRecommendation.mlSignals.riskBand + ' ML Risk'"
      [styleClass]="getMlRiskClass(finalRecommendation.mlSignals.riskBand)">
    </p-chip>
  </div>

  <div class="ml-signal-grid">

    <div class="ml-metric">
      <span>Anomaly Score</span>
      <strong>{{ finalRecommendation.mlSignals.anomalyScore | number:'1.2-2' }}</strong>
      <p-progressBar
        [value]="finalRecommendation.mlSignals.anomalyScore * 100"
        [showValue]="false">
      </p-progressBar>
    </div>

    <div class="ml-metric">
      <span>Risk Probability</span>
      <strong>{{ finalRecommendation.mlSignals.riskProbability * 100 | number:'1.0-0' }}%</strong>
      <p-progressBar
        [value]="finalRecommendation.mlSignals.riskProbability * 100"
        [showValue]="false">
      </p-progressBar>
    </div>

    <div class="ml-flag" *ngIf="finalRecommendation.mlSignals.isOutlier">
      <i class="pi pi-exclamation-circle"></i>
      This application exhibits anomalous ESG patterns compared to peer loans.
    </div>

  </div>

  <div class="ml-footer">
    ML signals are probabilistic indicators and support ‚Äî not replace ‚Äî human judgment.
  </div>

</div>

<!-- ===============================
     ESG CHECKLIST (REVIEW MODE)
================================ -->
<p-accordion
  [multiple]="true"
  [activeIndex]="isReadOnly ? [] : [0]">

  <p-accordionTab>
<ng-template pTemplate="header">
  <div class="accordion-header green">
    <i class="pi pi-list-check"></i>
    <span class="title">ESG Checklist Responses</span>
    <span class="subtitle">
      Completed assessment responses
    </span>
  </div>
</ng-template>


    <div class="esg-container" [class.read-only]="isReadOnly">

      <p-card
        *ngFor="let item of checklistItems"
        class="esg-card"
        [ngClass]="{ 'locked-card': isReadOnly }">

        <div class="esg-card-header">
          <h3>{{ item.item }}</h3>
          <span class="badge">{{ item.category }}</span>
        </div>

        <div class="esg-meta">
          <span class="meta-label">Indicator:</span>
          <span class="meta-value">{{ item.indicatorType }}</span>

          <span class="meta-label">Weight:</span>
          <span class="meta-value weight">{{ item.weight }}</span>
        </div>

        <div class="response-section">
          <label class="response-label">Selected Response:</label>

          <p-selectButton
            [options]="item.responses"
            optionLabel="label"
            optionValue="responseValue"
            [(ngModel)]="selectedResponses[item.checklistItemId]"
            class="response-button"
            [disabled]="isReadOnly">
          </p-selectButton>
        </div>

      </p-card>

    </div>
  </p-accordionTab>
</p-accordion>

  <!-- Mandatory ESG Comment -->
  <div class="assessment-comment-card" *ngIf="!isReadOnly">
    <label for="assessmentComment">
      <i class="pi pi-comment"></i>
      ESG Assessment Comment <span class="required">*</span>
    </label>

    <textarea id="assessmentComment" pInputTextarea rows="4" [(ngModel)]="assessmentComment"
      placeholder="Provide justification, ESG considerations, and observations for this loan assessment..."
      class="assessment-textarea">
  </textarea>
  </div>

  <div class="incomplete-hint" *ngIf="!isAssessmentComplete()">
    ‚ö†Ô∏è Please complete all checklist items before submitting.
  </div>

  <!-- ‚úÖ SUBMIT BAR -->
  <footer class="esg-submit-bar">

    <div class="submit-actions">
      <!-- Submit for Appraisal -->
      <button pButton label="Submit for Appraisal" icon="pi pi-send" class="p-button-outlined appraisal-btn"
        [disabled]="!isAssessmentComplete()" (click)="submitLoanApplicationForAppraisal()"
        *ngIf="!submittedForAppraisal">
      </button>

      <!-- Submit ESG Assessment -->
      <button pButton label="Submit ESG Assessment" icon="pi pi-check" class="p-button-success submit-btn"
        [disabled]="!isAssessmentComplete() || assessmentComment.trim().length < 10 || isReadOnly"
        (click)="confirmSubmit()">
      </button>

      <button pButton label="Back to ESG Pre-Screening" icon="pi pi-arrow-left" class="p-button-success goback-btn"
        (click)="backToPreScreen()">
      </button>

    </div>

  </footer>

</div>
<p-confirmDialog header="Confirm ESG Submission" icon="pi pi-exclamation-triangle" acceptLabel="Yes, Submit"
  rejectLabel="Review Again" styleClass="esg-confirm-dialog">
</p-confirmDialog>